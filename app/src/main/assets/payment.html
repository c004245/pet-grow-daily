<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>카카오페이 결제</title>

    <!-- PortOne (Iamport) Web SDK -->
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <style>
        body {
          font-family: Arial, sans-serif;
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
          background-color: #f8f9fa;
        }
        .payment-container {
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .product-info {
          text-align: center;
          margin-bottom: 30px;
        }
        .product-title {
          font-size: 24px;
          font-weight: bold;
          color: #333;
          margin-bottom: 10px;
        }
        .product-price {
          font-size: 20px;
          color: #e74c3c;
          font-weight: bold;
        }
        .pay-button {
          width: 100%;
          padding: 15px;
          background-color: #fee500; /* 카카오페이 컬러 느낌 */
          color: #3c1e1e;
          border: none;
          border-radius: 8px;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          margin-top: 20px;
        }
        .pay-button:hover { background-color: #fdd835; }
        .result-message {
          margin-top: 20px;
          padding: 15px;
          border-radius: 5px;
          text-align: center;
          display: none;
        }
        .success {
          background-color: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }
        .error {
          background-color: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }
        .hint {
          margin-top: 12px;
          color: #666;
          font-size: 13px;
          text-align: center;
        }
    </style>
</head>
<body>
<div class="payment-container">
    <div class="product-info">
        <div id="product-title" class="product-title">🐾 코팅형 고급 앨범</div>
        <div>사진 최대 40장 수록</div>
        <div id="product-price" class="product-price">27,000원</div>
    </div>

    <button class="pay-button" onclick="requestPay()">
        카카오페이로 결제하기
    </button>

    <div id="result" class="result-message"></div>

</div>

<script>
    // ==== 초기화 ====
    var IMP = window.IMP;
    IMP.init('imp28817041'); // 가맹점 식별코드

    // Android에서 값을 주입할 수 있도록 전역 상품 정보
    var productInfo = {
      name: '코팅형 고급 앨범',
      amount: 27000,
      merchantUid: 'album_' + new Date().getTime()
    };

    // Android에서 호출할 수 있는 함수 (상품명/금액/주문번호 동적 반영)
    function updateProductInfo(productName, productAmount, merchantUid) {
      console.log('[payment.html] updateProductInfo:', productName, productAmount, merchantUid);

      productInfo.name = productName;
      productInfo.amount = parseInt(productAmount);
      productInfo.merchantUid = merchantUid || ('album_' + new Date().getTime());

      // UI 반영
      document.getElementById('product-title').innerText = '🐾 ' + productName;
      document.getElementById('product-price').innerText = productInfo.amount.toLocaleString() + '원';
    }

    // ==== 결제 요청 ====
    function requestPay() {
      const resultEl = document.getElementById('result');
      resultEl.style.display = 'none';
      resultEl.className = 'result-message';
      resultEl.innerHTML = '';

      // 참고: Web SDK(모바일)에서는 callback보다는 m_redirect_url이 핵심입니다.
      IMP.request_pay({
        pg: 'kakaopay.TC0ONETIME',         // ✅ 테스트용. 운영 전환 시 'kakaopay'로 교체
        pay_method: 'kakaopay',            // 명시적으로 카카오페이
        merchant_uid: productInfo.merchantUid,
        name: productInfo.name,
        amount: productInfo.amount,

        // ✅ 외부 앱에서 열 수 있는 주소만 사용 (file:// 금지)
        // 커스텀 스킴으로 앱 복귀 → WebViewClient에서 처리
        m_redirect_url: 'petgrowdaily://pay/result'
        // Web SDK에서는 app_scheme 파라미터는 사용되지 않습니다.
      }, function (rsp) {
        // 모바일에선 보통 m_redirect_url로 복귀되므로 이 콜백은 참고용입니다.
        console.log('[payment.html] callback:', rsp);

        // (데스크톱 테스트 등) 콜백이 동작하는 경우에 대비하여 간단 표기
        resultEl.style.display = 'block';
        if (rsp.success) {
          resultEl.className = 'result-message success';
          resultEl.innerHTML =
            '✅ 결제 요청 성공 (callback)<br>' +
            '거래번호: ' + rsp.imp_uid + '<br>' +
            '결제금액: ' + (rsp.paid_amount || productInfo.amount).toLocaleString() + '원';
          try {
            if (window.Android && typeof window.Android.onPaymentSuccess === 'function') {
              window.Android.onPaymentSuccess(rsp.imp_uid, String(rsp.paid_amount || productInfo.amount));
            }
          } catch (e) { console.warn('Android.onPaymentSuccess (callback) error:', e); }
        } else {
          resultEl.className = 'result-message error';
          resultEl.innerHTML = '❌ 결제 실패 (callback)<br>' + (rsp.error_msg || '알 수 없는 오류');
          try {
            if (window.Android && typeof window.Android.onPaymentFailure === 'function') {
              window.Android.onPaymentFailure(rsp.error_msg || '결제가 취소되었습니다.');
            }
          } catch (e) { console.warn('Android.onPaymentFailure (callback) error:', e); }
        }
      });
    }

    // 디버그용: Android 인터페이스 유무 확인 로그
    window.addEventListener('load', function () {
      console.log('[payment.html] loaded. Android interface available:', !!window.Android);
      try {
        console.log('[payment.html] Android methods:', window.Android ? Object.keys(window.Android) : 'N/A');
      } catch (_) {}
    });
</script>
</body>
</html>
